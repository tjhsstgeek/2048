var gm;
var ai;
var ai_paused = true;
var ai_running = false;
var ai_int;
var stop_button = document.getElementById('stop_button');

//var features = [0.8294997271150351, -0.2550946641713381, -0.32458809297531843, 0.8151227398775518, 0.6648787492886186, 0.4866352961398661, -0.03434028523042798, 0.45089875580742955, -0.5321658360771835, -0.6900638733059168, 0.9314044411294162, -0.3362570623867214, -0.7555115553550422, -0.5858843820169568, -0.18306659953668714, 0.2109895353205502, -0.9984446833841503, 0.08793511376495652, 0.7337001119740307, 0.4829624746926129, -0.5190517348237336, -0.5579460105153102, 0.5999170076102018, -0.7536007813178003, 0.8898011562414467, 0.5815966143272817, 0.3193062860518694, -0.9812050256878138, 0.7109761722385883, 0.5177173088304698, -0.29982736986130476, 0.27757058339193463, -0.6946809608489275, -0.07792751770466566, 0.2602537227794528, 0.7611708315089345, 0.2993238610215485, 0.8177477642893791, -0.745142329018563, 0.9742378355003893, 0.7090319460257888, 0.8326506298035383, -0.7534091505222023, 0.7007296197116375, 0.48588367784395814, -0.2728601088747382, -0.21356114139780402, 0.574013146571815, -0.6304556811147416, -0.0881176944822073, 0.7054468598216772, -0.5376255605369806, 0.32858422864228487, -0.6476218327879906, -0.1008291277103126, -0.4330202518031001, 0.12252507591620088, -0.7573686675168574, 0.7484732139855623, 0.10883284453302622, 0.3257784197551109, 0.8092123428359628, -0.8982504191808403, -0.7476324304006994, -0.14389243349432945];
//var features = [0.9074798496440053, -0.371200961060822, 0.8057414288632572, -0.11314572186604546, -0.4797463067807257, -0.08236428862437606, 0.4366171294823289, -0.5068328427150846, 0.009806442661720441, -0.5334483501501381, -0.9040089827030897, 0.7824328173883259, -0.3493059208073298, -0.955395317170769, 0.36049671890214086, 0.6161011354997754, 0.6237248852849007, -0.5920795369893312, 0.4261357360519469, 0.47771665547043085, 0.8461182685568929, -0.20995310228317976, 0.44662782084196806, 0.6430115345865488, 0.9870682144537568, -0.6649790778756142, 0.49370114551857114, -0.4115098104812205, 0.04527330119162798, -0.7364756120368838, 0.7992733982391655, 0.14315603999421, -0.4841676144860685, 0.5798271927051246, 0.24391481885686517, 0.4783297358080745, 0.23228161875158548, 0.7014232175424695, -0.2103307475335896, 0.4397504013031721, 0.6566541246138513, 0.006451692698542039, 0.1354498597793281, 0.6432988434098661, 0.4668853129260242, 0.8523760889656842, 0.2338136862963438, -0.17416741559281945, -0.31436661072075367, -0.4541833526454866, 0.2045195223763585, -0.0896683749742806, -0.48908254550769925, -0.6279753618873656, -0.5395792410708964, -0.43510517943650484, 0.4533959929831326, 0.09175332821905613, -0.29927479196339846, 0.2016086708754301, 0.5914109675213695, -0.6306730122305453, 0.554081916809082, 0.9953252449631691, 0.857701875269413]
//var features = [0.9074798496440053, -0.371200961060822, 0.8057414288632572, -0.11314572186604546, -0.4797463067807257, -0.08236428862437606, 0.4366171294823289, -0.5068328427150846, 0.009806442661720441, -0.5334483501501381, -0.9040089827030897, 0.7824328173883259, -0.3493059208073298, -0.955395317170769, 0.36049671890214086, 0.6161011354997754, 0.6237248852849007, -0.5920795369893312, 0.4261357360519469, 0.47771665547043085, 0.8461182685568929, -0.20995310228317976, 0.44662782084196806, 0.6430115345865488, 0.9870682144537568, -0.6649790778756142, 0.49370114551857114, -0.4115098104812205, 0.04527330119162798, -0.7364756120368838, 0.7992733982391655, 0.14315603999421, -0.4841676144860685, 0.5798271927051246, 0.24391481885686517, 0.4783297358080745, 0.23228161875158548, 0.7014232175424695, -0.2103307475335896, 0.4397504013031721, 0.6566541246138513, 0.006451692698542039, 0.1354498597793281, 0.6432988434098661, 0.4668853129260242, 0.8523760889656842, 0.2338136862963438, -0.17416741559281945, -0.31436661072075367, -0.4541833526454866, 0.2045195223763585, -0.0896683749742806, -0.48908254550769925, -0.6279753618873656, -0.5395792410708964, -0.43510517943650484, 0.4533959929831326, 0.09175332821905613, -0.29927479196339846, 0.2016086708754301, 0.5914109675213695, -0.6306730122305453, 0.554081916809082, 0.9953252449631691, 0.857701875269413];

//var features = [0.9934059791266918, -0.2535351230762899, -0.12784263212233782, -0.3444067598320544, 0.8768306588754058, -0.6087519931606948, -0.9087507100775838, -0.2268892708234489, -0.33644206216558814, 0.2199862222187221, 0.17082027485594153, 0.5067677437327802, 0.7511215838603675, -0.5796972320807846, -0.7700588679872453, 0.7877564318478107, -0.042161563344643306, 0.7164369388483465, 0.2752294158563018, 0.144090108881572, -0.7165815723128617, 0.41486641112715006, 0.046661656002427, -0.9275862779468298, 0.9731286950409412, -0.5976080712862313, 0.5329863880760968, -0.12249847504822081, 0.37736854841932654, 0.7645061216317117, 0.38075974490493536, -0.1919738119468093, 0.5208272449672222, 0.23128575389143113, 0.852407340425998, 0.19730634475126863, 0.22679602773860097, -0.7758246907033026, -0.3615360176190734, 0.9507875577546656, -0.5686717657372355, 0.9410329204984009, 0.708706425037235, 0.8868370819836855, -0.44513824535533786, 0.06563326483592391, 0.22963998327031732, -0.5952444039285183, 0.23939217906445265, 0.3866691645234823, 0.48021676763892174, -0.001027681864798069, -0.6464665527455509, -0.33562547294422984, -0.4575960198417306, 0.07826958037912846, -0.47501903399825096, -0.26118724048137665, -0.40507297264412045, -0.1871143849566579, 0.07077217800542712, -0.7624808675609529, 0.29033936001360416, -0.8578575555820029, -0.8249705359339714];
//var features = [0.867074599955231, -0.47961695212870836, 0.5937053365632892, 0.39834048645570874, 0.8300459245219827, 0.6111656236462295, -0.4845175971277058, -0.979836221318692, 0.3324773823842406, -0.806786734610796, 0.5845866594463587, 0.2863833215087652, 0.12554689310491085, -0.5991661245934665, -0.25534960720688105, 0.036482310853898525, 0.7060516364872456, -0.39351140102371573, 0.702659166418016, 0.45898263854905963, 0.8681922783143818, 0.2846353454515338, 0.37564829573977504, -0.0038607120513916016, 0.5552196907810867, 0.2946591400541365, 0.4571881606243551, -0.8781272573396564, -0.8722687740810215, -0.5813326111688878, 0.27034898987039924, -0.18788585951551795, 0.025842738803476095, -0.13610750110819936, 0.08618569560348988, 0.516493936534971, 0.8377765878103673, -0.04101689159870148, 0.002329675480723381, -0.9978163214400411, -0.6161291159328334, -0.19503049531106173, -0.8734271083958447, -0.10446353163570166, -0.8630591873079538, 0.7604853739030659, 0.7635003090836108, 0.8166584009304643, 0.4178044577129185, 0.8501844024285674, 0.4919361602514982, -0.21796717308461666, 0.39245639741420746, -0.6994217615574598, -0.4256008812226355, 0.32803905941545963, -0.6028950973413885, 0.814327132422477, 0.1007443224079907, -0.8046931841916448, 0.2972049000672996, 0.8457334754057229, -0.5780315920710564, -0.12291176244616508, 0.558235873002559];
//var features = [1.5569717616150391, -0.8790250607505044, 0.3865302018338816, -0.34372703439633134, -0.5292092633556207, 0.09996319998083739, -0.261670740775979, -0.4963574369678164, 0.0014826963765737639, 0.05204948927637082, -0.1786076612260582, 0.5078726784009642, 0.3639132398717144, 0.20047751448689333, -0.620013359710337, -0.3159622982898537, 0.3485228569542655, 0.635697417618339, 0.37964642695537326, 0.6035785284290438, -0.23126606171122685, 0.3221511313651741, 0.6009078964455317, -0.33343815344173033, 0.12361273531904005, 0.4825284928051494, 0.7654202491125167, -0.23298889344517143, -0.07025884430818491, 0.03905911935594221, -0.5536865101328067, 0.07853011096888807, -0.339308292376347, 0.589243679255397, 0.6328708167409022, 0.28636560955531387, 0.21938279168332267, -0.1302193297564066, -0.08819942421560592, -0.10936787346041216, 0.1412523386318048, -0.39383887418153996, -0.30899171519802693, 0.49117909479787697, -0.050465202576326806, 0.2002916382151732, -0.7344875795168283, 0.3270242810834887, 0.06670128086437557, 0.9812262890494028, 0.40663530451792507, 0.39545234517921696, -0.040185013156747884, -0.02765352924082476, -0.31835319111820815, 0.03964629009171228, 0.015488003484245255, -0.372575476689794, 0.3499754647463598, -0.023254366656449643, 0.7765965793399808, -0.0537617835628775, -0.0326716475522596, 0.4320394713465016, -0.16039724036846695];
//var features = [1.7551901813292268, -0.9480620607732095, 0.03836626896693468, 0.6853203096365109, 0.5525613471163144, 0.22077545451355735, -0.6359220349678972, 0.5930600251559458, -0.2440817267658949, -1.1940528194818736, 0.46609390143176055, -0.10335722937411546, 0.059190888066670784, -0.46165913874521836, 0.14006879948048648, 0.11808281056208125, 0.10161506018470678, -0.0014449430982263756, -0.0058560337134116874, 0.9607668697706802, -0.6015676658303077, 0.27882732464704824, 0.5968254689735293, -0.13943818454012352, 0.3148700867486276, -0.018416441187003585, -0.17462309800583453, -0.22649500095784467, 1.3361242445378068, 0.7261214860473115, -0.1188233992248994, -0.6916456512842684, -1.0425652686836573, -0.24310526415996275, 1.030007935661866, 0.5866580003304644, 0.3683770779155936, 0.45501825618230224, 0.8067921751978526, -0.5780472241307609, 0.05559142733504713, -0.9071535526474737, -0.03439665578093551, 0.3146836474326602, -0.3548348615556146, 0.1880442891593624, -0.5741900638632841, 0.49723395454626673, -0.7505413705985451, -0.7120551377051363, -0.011454831242248442, -0.4717676623480446, 0.10704022836156521, 0.029139045537385055, -0.25317276229532826, 0.11082620484994085, -0.4939472537869103, -1.1735810586891635, -0.6199530761701043, -0.8375965133451692, -0.678106669859305, -0.35619722727030245, 0.16053532642358362, 0.38598056705556844, -0.11916265327188713];


//~1500 Average
var features = [2.499816103312745, 0.365294223418849, -0.10644308032358873, -0.033294606124114834, 0.6167424627508133, 0.3117682249929283, -0.26580828872202467, 0.24767310212390564, 0.569966485493674, -0.48937090332056277, 0.479951291453488, -0.12980568823914715, -0.12029737438986454, -0.6567681071593563, 0.717261107982469, -0.06207264452919564, -0.1582482454204977, 0.002301498496808496, 1.010609821016056, 0.6136096062916765, 0.8195214236904798, 0.6388801879088991, -0.6393561907888111, -0.22399236758144747, -0.5823129518522483, 0.9068170602945651, 0.8409932906019787, 0.37198184748467444, 0.34190053135007165, -0.8454489856591698, 1.290862499030419, -0.15616726707548328, -0.021459562276324007, 0.33729014359499576, 0.7412924878681955, 1.5033457467251403, 0.9238032637336666, -0.7136019278885661, -1.3104465553833193, -0.7193666732365793, 0.2601124603454707, -0.3201469639208816, -0.017086242839515847, 0.11588533491618594, 0.7471307122161557, -0.349742980040105, -0.16135563194007269, 0.09135310221861814, -0.12559484833241763, -0.8604452296315499, 1.2974306005486491, 0.35864906594562007, 0.1202182856046054, -0.12936514638743724, -0.34949185353627155, 1.0771082436793693, 0.19189839681578902, -0.104813265690398, -0.01994360600836774, 0.8165489877549852, 0.551467516064787, 0.09763315927782207, 1.1725295512047804, 0.3066870127966282, 0.18405908545441463];

function ai_stop() {
	if (!ai_running)
		return;
	ai_pause();
	ai_running = false;

	document.getElementById('ai_stop').disabled = true;
	document.getElementById('ai_start').disabled = false;
	document.getElementById('ai_cont').disabled = true;
}

function ai_pause() {
	if (ai_paused)
		return;
	clearInterval(ai_int);
	ai_paused = true;

	document.getElementById('ai_pause').disabled = true;
	document.getElementById('ai_cont').disabled = false;
}

function ai_continue() {
	if (!ai_paused)
		return;
	ai_paused = false;

	ai_int = setInterval(function () {
		gm.grid.eachCell(function (x, y, tile) {
			if (tile) {
				ai.set(x, y, Math.log(tile.value) / Math.LN2);
			} else {
				ai.set(x, y, 0);
			}
		});
		var r = 4;
		var dir = ai.bruteforce(r);

		if (dir == -1) {
			ai_stop();
			return;
		}

		gm.inputManager.emit("move", dir);
		if (gm.over) {
			ai_stop();
		} else if (gm.won && !gm.keepPlaying) {
			gm.inputManager.emit("keepPlaying");
		}
	}, 10);

	document.getElementById('ai_pause').disabled = false;
	document.getElementById('ai_cont').disabled = true;
}

function ai_start() {
	if (ai_running)
		return;
	gm.restart();
	ai_running = true;
	ai_continue();

	document.getElementById('ai_stop').disabled = false;
	document.getElementById('ai_start').disabled = true;
}

function select_option(size) {
	var s = size.split("x");
	set_size(parseInt(s[0]), parseInt(s[1]));
}

function set_size(w, h) {
	ai_stop();

	if (gm)
		gm.stop();

	var table = document.querySelector(".grid-container");
	while (table.firstChild) table.removeChild(table.firstChild);

	var nw = 15 + (106.25 + 15) * w;
	var nh = 15 + (106.25 + 15) * h;
	var game = document.querySelector(".game-container");
	game.style.width = nw + "px";
	game.style.height = nh + "px";

	for (var y = 0;y < h;y++) {
		var tr = document.createElement('div');
		tr.className = "grid-row";
		for (var x = 0;x < w;x++) {
			var td = document.createElement('div');
			td.className = "grid-cell";

			tr.appendChild(td);
		}

		table.appendChild(tr);
	}

	gm = new GameManager(w, h, KeyboardInputManager, HTMLActuator, LocalScoreManager);
	ai = new ai_grid(w, h, 4, features);
}

var doGA = false;
if (doGA) {
	var g = new ga(4, 4, 2, 65, 256, 16, 0.05);
	//var g = new ga(4, 4, 3, 65, 32, 2, 0.05);
	//var g = new ga(4, 4, 1, 65, 128, 8, 0.05);
	setInterval(function() {
		g.tick();
	}, 10);
}

// Wait till the browser is ready to render the game (avoids glitches)
window.requestAnimationFrame(function () {
  set_size(4, 4);
});
